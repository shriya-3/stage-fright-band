const express = require("express");
const nodemailer = require("nodemailer");
const cors = require("cors");
const bodyParser = require("body-parser");

const app = express();
const port = 5000;

app.use(cors());
app.use(bodyParser.json());

// POST route to handle order placement
app.post("/api/place-order", (req, res) => {
  const { email, cart, seat, price } = req.body;

  // Prepare the order details for the email
  let orderDetails = `Your order details:\n\n`;

  // Add cart items to order details
  cart.forEach(item => {
    orderDetails += `Item: ${item.name}, Quantity: ${item.quantity}, Price: $${(item.price * item.quantity).toFixed(2)}\n`;
  });

  // Add seat information if available
  if (seat) {
    orderDetails += `Selected Seat: ${seat}, Price: $${price}\n`;
  }

  // Calculate the total price
  const totalPrice = (cart.reduce((total, item) => total + item.price * item.quantity, 0) + (seat ? price : 0)).toFixed(2);
  orderDetails += `\nTotal Price: $${totalPrice}`;

  // Set up the email transporter (example using Gmail)
  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: 'your-email@gmail.com', // Your email
      pass: 'your-email-password'    // Your email password or app-specific password
    }
  });

  // Email message options
  const mailOptions = {
    from: 'your-email@gmail.com',
    to: email,
    subject: 'Order Confirmation',
    text: `Thank you for your order! Here are your order details:\n\n${orderDetails}`,
    attachments: [
      {
        filename: 'ticket.png',
        path: 'path-to-your-ticket-image/ticket.png', // Path to your ticket image
        cid: 'ticket_image' // You can reference this CID in the email body
      }
    ]
  };

  // Send email
  transporter.sendMail(mailOptions, (error, info) => {
    if (error) {
      console.log(error);
      return res.status(500).json({ error: "Email failed to send" });
    }
    res.status(200).json({ message: "Order placed successfully and email sent!" });
  });
});

app.listen(port, () => {
  console.log(`Server is running on http://localhost:${port}`);
});
